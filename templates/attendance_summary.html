{% extends 'base.html' %}

{% block title %}attendance_summary - BunkWise{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Subject Attendance Summary</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="p-5 bg-light">

<div class="container bg-white p-4 rounded shadow-sm">
    <h2 class="text-center mb-4">üìä Subject-wise Attendance Summary</h2>

    {% if summary %}
    <table class="table table-bordered table-striped">
        <thead class="table-primary">
            <tr>
                <th>Subject</th>
                <th>Classes Attended</th>
                <th>Total Classes</th>
                <th>Attendance %</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for subject, data in summary.items() %}
            <tr>
                <td><strong>{{ subject }}</strong></td>
                <td>{{ data.present }}</td>
                <td>{{ data.total }}</td>
                <td>
                    {% set percentage = data.percentage|float %}
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar 
                            {% if percentage >= 75 %} bg-success 
                            {% elif percentage >= 50 %} bg-warning 
                            {% else %} bg-danger 
                            {% endif %}" 
                            role="progressbar" style="width: {{ percentage }}%;" 
                            aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100">
                            {{ data.percentage }}%
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn btn-info btn-sm predict-btn" data-subject="{{ subject }}">
                        BunkSafe? üß†
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-warning text-center">No attendance data is available to summarize.</div>
    {% endif %}

    <div class="text-center mt-4">
        <a href="{{ url_for('mark_attendance_today') }}" class="btn btn-secondary">‚¨Ö Back to Mark Attendance</a>
    </div>
</div>

<div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="predictionModalLabel">BunkWise Prediction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="prediction-modal-body">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const predictionModalElement = document.getElementById('predictionModal');
    if (!predictionModalElement) return;

    const predictionModal = new bootstrap.Modal(predictionModalElement);
    const modalBody = document.getElementById('prediction-modal-body');

    document.querySelectorAll('.predict-btn').forEach(button => {
        button.addEventListener('click', function () {
            const subject = this.dataset.subject;
            
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            predictionModal.show();

            fetch(`/predict_bunk/${subject}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }

        let verdictClass = data.is_safe_to_bunk ? 'alert-success' : 'alert-danger';
        let verdictText = data.is_safe_to_bunk ? 'Safe to Bunk ‚úÖ' : 'Risky! ‚ö†Ô∏è';
        
        // --- NEW LOGIC TO DISPLAY THE WARNING ---
        let eventWarningHtml = '';
        if (data.event_warning) {
            // If there's an event, create a special warning block
            eventWarningHtml = `<div class="alert alert-warning"><strong>${data.event_warning}</strong></div>`;
        }

        let html = `
            <h4>Subject: ${data.subject}</h4>
            ${eventWarningHtml} <div class="alert ${verdictClass}"><strong>Verdict: ${verdictText}</strong></div>
            <p>If you bunk the next class, you will have <strong>${data.bunks_remaining_after_this}</strong> bunks remaining.</p>
            <hr>
            <h5>Details:</h5>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Max Allowed Bunks: 
                    <span class="badge bg-secondary rounded-pill">${data.current_attendance_stats.max_allowed_bunks}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Bunks Already Taken: 
                    <span class="badge bg-warning rounded-pill">${data.current_attendance_stats.current_bunks}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Total Classes in Semester: 
                    <span class="badge bg-primary rounded-pill">${data.semester_stats.total_net_classes}</span>
                </li>
            </ul>
        `;
        
        modalBody.innerHTML = html;
    })
    .catch(error => {
        modalBody.innerHTML = `<div class="alert alert-danger">An error occurred while fetching the prediction.</div>`;
        console.error('Error:', error);
          });
        });
    });
});
</script>

</body>
</html>

{% endblock %}
